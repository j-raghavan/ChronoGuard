name: Code Quality Checks

on:
  push:
    branches: [ master, develop, feat/* ]
  pull_request:
    branches: [ master, develop ]

jobs:
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,lint,security]"

      - name: Run ruff linting
        working-directory: ./backend
        run: |
          echo "ğŸ” Running ruff linting..."
          ruff check src/ tests/ --output-format=github

      - name: Run ruff formatting check
        working-directory: ./backend
        run: |
          echo "ğŸ¨ Checking code formatting..."
          ruff format --check src/ tests/

      - name: Run black formatting check
        working-directory: ./backend
        run: |
          echo "ğŸ–¤ Running black formatting check..."
          black --check --diff src/ tests/

      - name: Run isort import sorting check
        working-directory: ./backend
        run: |
          echo "ğŸ“¦ Checking import sorting..."
          isort --check-only --diff src/ tests/

      - name: Run mypy type checking
        working-directory: ./backend
        run: |
          echo "ğŸ” Running mypy type checking..."
          mypy src/ --show-error-codes --show-error-context

      - name: Run bandit security analysis
        working-directory: ./backend
        run: |
          echo "ğŸ”’ Running security analysis..."
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -f txt

      - name: Run safety dependency check
        working-directory: ./backend
        run: |
          echo "ğŸ›¡ï¸ Checking dependency vulnerabilities..."
          safety check --json || true
          safety check

      - name: Python syntax compilation check
        working-directory: ./backend
        run: |
          echo "âš™ï¸ Checking Python syntax compilation..."
          python -m py_compile $(find src/ -name "*.py")

      - name: Import validation
        working-directory: ./backend
        run: |
          echo "ğŸ“¥ Validating module imports..."
          PYTHONPATH=src python -c "
          from core.features import FeatureManager; print('âœ… Core systems')
          from domain.agent import Agent; print('âœ… Agent domain')
          from domain.policy import Policy; print('âœ… Policy domain')
          from domain.audit import AuditEntry; print('âœ… Audit domain')
          print('ğŸ‰ All modules import successfully')
          "

      - name: Upload security reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-reports
          path: |
            backend/bandit-report.json
          retention-days: 30

  frontend-quality:
    name: Frontend Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: |
          npm ci

      - name: Run ESLint
        working-directory: ./frontend
        run: |
          echo "ğŸ” Running ESLint..."
          npm run lint

      - name: Run Prettier formatting check
        working-directory: ./frontend
        run: |
          echo "ğŸ¨ Checking Prettier formatting..."
          npm run format:check

      - name: Run TypeScript type checking
        working-directory: ./frontend
        run: |
          echo "ğŸ” Running TypeScript type checking..."
          npm run type-check

      - name: Build frontend
        working-directory: ./frontend
        run: |
          echo "ğŸ—ï¸ Building frontend..."
          npm run build